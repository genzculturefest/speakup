<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speak Up - Admin Database Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f1f5f9; 
        }
        .table-container {
            max-height: calc(100vh - 300px); /* Disesuaikan sedikit untuk search bar */
            overflow-y: auto;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #1e3a8a;
            color: white;
            z-index: 10;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-6 rounded-[30px] shadow-sm">
            <div>
                <h1 class="text-2xl font-black text-blue-900 italic uppercase tracking-tighter">Speak Up Database</h1>
                <p class="text-slate-500 text-sm">Manajemen data pendaftar & verifikasi pembayaran</p>
            </div>
            <div class="flex gap-3">
                <button onclick="fetchData()" id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl font-bold transition-all flex items-center gap-2 shadow-lg shadow-blue-200">
                    <span id="refreshIcon">üîÑ</span> Refresh Data
                </button>
            </div>
        </div>

        <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-600">
                <p class="text-xs font-bold text-slate-400 uppercase">Total Peserta</p>
                <p id="statTotal" class="text-2xl font-black text-slate-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500">
                <p class="text-xs font-bold text-slate-400 uppercase">Sudah Bayar</p>
                <p id="statPaid" class="text-2xl font-black text-slate-800">0</p>
            </div>
        </div>

        <div class="mb-6">
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-slate-400">üîç</span>
                <input type="text" id="searchInput" onkeyup="filterTable()" 
                    placeholder="Cari nama, email, atau instansi..." 
                    class="w-full p-4 pl-12 rounded-2xl border border-white bg-white shadow-sm focus:ring-2 focus:ring-blue-400 focus:border-transparent outline-none transition-all font-medium text-slate-600">
            </div>
        </div>

        <div class="bg-white rounded-[30px] shadow-xl overflow-hidden border border-slate-100">
            <div class="table-container">
                <table class="w-full text-left border-collapse">
                    <thead id="tHead" class="sticky-header">
                        </thead>
                    <tbody id="tBody" class="text-[13px] font-medium text-slate-600">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-8 rounded-[40px] text-center shadow-2xl">
                <div class="animate-spin text-4xl mb-4">üåÄ</div>
                <p class="font-black text-blue-900 uppercase">Memproses Data...</p>
            </div>
        </div>
    </div>

    <script>
    // === KONFIGURASI: TEMPEL URL WEB APP ANDA DI SINI ===
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzT6xgcxtC516CfJaVvhxRwDhFTub-FsDLTlBtzUJiS_TTjpHyvqss5_qY_3-5Wumzv5g/exec";

    async function fetchData() {
        toggleLoader(true);
        try {
            const response = await fetch(`${WEB_APP_URL}?action=read`);
            const data = await response.json();
            renderTable(data);
            updateStats(data);
        } catch (err) {
            alert("Gagal memuat data! Periksa URL Web App atau koneksi internet.");
            console.error(err);
        } finally {
            toggleLoader(false);
        }
    }

    function renderTable(data) {
        const head = document.getElementById('tHead');
        const body = document.getElementById('tBody');
        
        // Header
        let hHtml = "<tr>";
        data[0].forEach(h => {
            hHtml += `<th class="p-4 uppercase text-[10px] tracking-widest font-black text-white">${h}</th>`;
        });
        hHtml += "</tr>";
        head.innerHTML = hHtml;

        // Body
        let bHtml = "";
        for (let i = 1; i < data.length; i++) {
            bHtml += `<tr class="border-b border-slate-50 hover:bg-blue-50/50 transition-all">`;
            data[i].forEach((cell, j) => {
                
                // 1. Kolom Bukti Bayar (Index 7)
                if (j === 7 && cell.toString().includes('http')) {
                    bHtml += `<td class="p-3"><a href="${cell}" target="_blank" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-bold hover:bg-blue-200 transition-all uppercase inline-block">Buka Foto</a></td>`;
                } 
                
                // 2. Kolom Status Bayar (Index 9) - JADI DROPDOWN
                else if (j === 9) {
                    const statusVal = cell.toString().toUpperCase().trim();
                    const colorClass = statusVal === "SUKSES" ? "bg-green-100 text-green-700 border-green-200" : "bg-orange-100 text-orange-700 border-orange-200";
                    
                    bHtml += `
                    <td class="p-2">
                        <select onchange="updateCell(${i}, ${j}, this.value)" 
                                class="w-full p-2 rounded-xl font-bold border outline-none focus:ring-2 ring-blue-400 cursor-pointer ${colorClass}">
                            <option value="PENDING" ${statusVal === "PENDING" ? "selected" : ""}>PENDING</option>
                            <option value="SUKSES" ${statusVal === "SUKSES" || statusVal === "SUKES" ? "selected" : ""}>SUKSES</option>
                            <option value="GAGAL" ${statusVal === "GAGAL" ? "selected" : ""}>GAGAL</option>
                        </select>
                    </td>`;
                }
                
                // 3. Input Biasa (Text)
                else {
                    bHtml += `
                    <td class="p-2">
                        <input type="text" value="${cell}" 
                            onchange="updateCell(${i}, ${j}, this.value)"
                            class="w-full bg-transparent p-2 rounded-lg border border-transparent hover:border-slate-200 focus:bg-white focus:shadow-sm focus:border-blue-400 outline-none transition-all">
                    </td>`;
                }
            });
            bHtml += "</tr>";
        }
        body.innerHTML = bHtml;
    }

    async function updateCell(row, col, value) {
    toggleLoader(true);
    const url = `${WEB_APP_URL}?action=update&row=${row}&col=${col}&val=${encodeURIComponent(value)}`;
    
    try {
        await fetch(url, { mode: 'no-cors' });
        console.log("Update Berhasil");
        
        if (col === 9) {
            if (value === "SUKSES") {
                // POP-UP CUSTOM GANTINYA ALERT
                Swal.fire({
                    title: 'Status Diperbarui!',
                    text: 'Status berhasil diubah ke SUKSES. Tiket QR akan segera dikirim ke email peserta.',
                    icon: 'success',
                    borderRadius: '25px',
                    confirmButtonColor: '#1e3a8a', // Warna biru Speak Up
                    confirmButtonText: 'Kembali',
                    background: '#ffffff',
                    showClass: {
                        popup: 'animate__animated animate__fadeInUp'
                    }
                });
            }
            fetchData(); 
        }
    } catch (err) {
        Swal.fire({
            title: 'Waduh!',
            text: 'Gagal mengupdate data ke Spreadsheet.',
            icon: 'error',
            confirmButtonColor: '#ef4444'
        });
    } finally {
        toggleLoader(false);
    }
}

    // FUNGSI PENCARIAN
    function filterTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toUpperCase();
    const table = document.getElementById("tBody");
    const tr = table.getElementsByTagName("tr");

    for (let i = 0; i < tr.length; i++) {
        let rowVisible = false;
        const tds = tr[i].getElementsByTagName("td");
        
        // Loop setiap kolom untuk mencari teks
        for (let j = 0; j < tds.length; j++) {
            const td = tds[j];
            if (td) {
                // Ambil teks dari teks langsung ATAU dari nilai input/select di dalamnya
                const inputChild = td.querySelector('input');
                const selectChild = td.querySelector('select');
                
                let textValue = "";
                if (inputChild) {
                    textValue = inputChild.value;
                } else if (selectChild) {
                    textValue = selectChild.value;
                } else {
                    textValue = td.textContent || td.innerText;
                }

                if (textValue.toUpperCase().indexOf(filter) > -1) {
                    rowVisible = true;
                    break; 
                }
            }
        }
        tr[i].style.display = rowVisible ? "" : "none";
    }
}

    function updateStats(data) {
        const total = data.length - 1;
        let paid = 0;
        for (let i = 1; i < data.length; i++) {
            const status = data[i][9].toString().toUpperCase().trim();
            if (status === "SUKSES" || status === "SUKES") paid++;
        }
        document.getElementById('statTotal').innerText = total;
        document.getElementById('statPaid').innerText = paid;
    }

    function toggleLoader(show) {
        document.getElementById('loader').classList.toggle('hidden', !show);
    }

    fetchData();
</script>
</html>
